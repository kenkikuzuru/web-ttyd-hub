# Web TTYd Hub - 需求文档

## 项目概述

Web TTYd Hub 是一个基于 Node.js 的 Web 终端会话管理工具，用于管理多个 `ttyd` 终端会话。用户可以通过浏览器创建、管理和切换多个终端会话，支持多人同时连接同一会话进行协作。

本项目面向个人使用场景，不提供对外服务，无需复杂的用户认证机制。

## 技术栈

- **后端**: Node.js + Express
- **前端**: Vue 3 + Vite
- **通信**: REST API + WebSocket（状态推送）
- **终端**: ttyd + tmux
- **UI 风格**: 现代深色主题，科技感界面

## 核心概念

每个"会话"对应一个独立的 ttyd 进程，底层运行 `tmux new -A -s <session-name>`。ttyd 以 `-W`（可写模式）启动，监听独立端口。用户通过前端 iframe 嵌入 ttyd 页面来使用终端。

## 功能需求

### 1. 会话管理

#### 1.1 创建会话

- 用户可以指定会话名称创建新会话
- 会话名称仅允许字母、数字、短横线、下划线
- 系统自动分配可用端口启动 ttyd 进程
- ttyd 启动命令格式: `ttyd -W -p <port> --bind 0.0.0.0 tmux new -A -s <session-name>`
- 创建成功后返回会话信息（名称、端口、状态）

#### 1.2 会话列表

- 展示所有会话的列表，包含以下信息：
  - 会话名称
  - 运行状态（运行中 / 已停止）
  - 分配端口
  - 创建时间
  - 当前连接数（如可获取）
- 支持实时刷新会话状态

#### 1.3 停止会话

- 停止指定会话的 ttyd 进程
- 保留 tmux session（下次可重新连接）

#### 1.4 删除会话

- 停止 ttyd 进程
- 同时销毁对应的 tmux session
- 从会话列表中移除

#### 1.5 重启会话

- 对已停止的会话重新启动 ttyd 进程
- 通过 `tmux new -A -s` 自动附加到已有的 tmux session

### 2. 终端访问

#### 2.1 会话切换

- 前端提供会话选项卡或侧边栏，点击即可切换到对应终端
- 通过 iframe 加载对应 ttyd 的 Web 页面
- 切换时保持其他会话继续运行

#### 2.2 多人协作

- 多个浏览器可同时访问同一会话
- 所有连接者看到相同的终端内容（ttyd 原生支持）
- 服务监听 `0.0.0.0`，局域网内其他设备可访问

### 3. 前端界面

#### 3.1 整体布局

- 深色主题，科技感 UI
- 左侧：会话列表侧边栏（可折叠）
- 右侧：终端显示区域（iframe）
- 顶部：简洁工具栏

#### 3.2 侧边栏

- 显示所有会话卡片
- 每个卡片展示：会话名称、状态指示灯（绿色运行/灰色停止）
- 卡片上提供快捷操作按钮（停止、删除）
- 底部提供"新建会话"按钮
- 支持折叠收起以最大化终端区域

#### 3.3 终端区域

- 使用 iframe 嵌入 ttyd 页面
- 自适应填满剩余空间
- 无会话时显示欢迎页面，引导用户创建第一个会话

#### 3.4 新建会话弹窗

- 简洁的模态框
- 输入会话名称
- 确认创建按钮

#### 3.5 视觉风格

- 配色：深色背景（#0a0a0f 类），霓虹色点缀（青色 #00ffd5、紫色 #b44aff）
- 卡片和面板使用毛玻璃效果（backdrop-filter: blur）
- 状态变化使用平滑过渡动画
- 按钮和交互元素带有微光/发光效果

## API 设计

### REST API

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/sessions` | 获取所有会话列表 |
| POST | `/api/sessions` | 创建新会话 |
| DELETE | `/api/sessions/:name` | 删除会话（停止进程 + 销毁 tmux） |
| POST | `/api/sessions/:name/stop` | 停止会话（仅停止 ttyd） |
| POST | `/api/sessions/:name/restart` | 重启会话 |

### WebSocket

- 路径: `/ws`
- 用途: 推送会话状态变更事件（创建、停止、删除、异常退出）
- 前端收到事件后自动刷新会话列表

## 配置项

通过环境变量或配置文件设置：

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `PORT` | 管理服务监听端口 | `3000` |
| `HOST` | 管理服务监听地址 | `0.0.0.0` |
| `TTYD_PORT_RANGE_START` | ttyd 端口范围起始 | `7681` |
| `TTYD_PORT_RANGE_END` | ttyd 端口范围结束 | `7780` |

## 项目结构

```
web-ttyd-hub/
├── doc/                    # 文档
├── server/                 # 后端
│   ├── index.js            # 入口
│   ├── routes/             # API 路由
│   │   └── sessions.js
│   ├── services/           # 业务逻辑
│   │   ├── session-manager.js   # 会话管理核心
│   │   └── port-manager.js      # 端口分配
│   └── ws.js               # WebSocket 处理
├── frontend/               # 前端 Vue 项目
│   ├── src/
│   │   ├── App.vue
│   │   ├── components/
│   │   │   ├── Sidebar.vue       # 侧边栏
│   │   │   ├── SessionCard.vue   # 会话卡片
│   │   │   ├── TerminalView.vue  # 终端区域
│   │   │   └── CreateDialog.vue  # 新建弹窗
│   │   ├── stores/
│   │   │   └── sessions.js       # 会话状态管理
│   │   └── styles/
│   │       └── global.css        # 全局样式
│   └── vite.config.js
├── package.json
└── README.md
```

## 非功能需求

- ttyd 进程异常退出时，自动更新会话状态为"已停止"
- 管理服务退出时，清理所有已启动的 ttyd 子进程
- 端口冲突时自动跳过，分配下一个可用端口
